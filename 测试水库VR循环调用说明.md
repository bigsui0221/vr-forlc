# 🔄 测试水库VR资源循环调用说明

## 📋 调用规则

测试水库的VR资源现在按照 **1-2-3-4-1-2-3-4** 的循环顺序调用：

| 测试水库编号 | 使用的VR图像 | 循环位置 | 文件大小 | 优化状态 |
|-------------|-------------|----------|----------|----------|
| 测试水库1   | 1.hdr       | 1️⃣      | 27MB     | ⚠️ 需要优化 |
| 测试水库2   | 2.hdr       | 2️⃣      | 5.8MB    | ✅ 已优化 |
| 测试水库3   | 3.hdr       | 3️⃣      | 6.3MB    | ✅ 已优化 |
| 测试水库4   | 4.hdr       | 4️⃣      | 7.2MB    | ✅ 已优化 |
| 测试水库5   | 1.hdr       | 1️⃣      | 27MB     | ⚠️ 需要优化 |
| 测试水库6   | 2.hdr       | 2️⃣      | 5.8MB    | ✅ 已优化 |
| 测试水库7   | 3.hdr       | 3️⃣      | 6.3MB    | ✅ 已优化 |
| 测试水库8   | 4.hdr       | 4️⃣      | 7.2MB    | ✅ 已优化 |
| 测试水库9   | 1.hdr       | 1️⃣      | 27MB     | ⚠️ 需要优化 |
| 测试水库10  | 2.hdr       | 2️⃣      | 5.8MB    | ✅ 已优化 |
| ...         | ...         | ...      | ...      | ... |

## 🔧 实现原理

### 1. **动态图像分配算法**
```javascript
// 计算VR图像索引：1-2-3-4循环
const reservoirNumber = parseInt(reservoirName.replace('测试水库', '')) || 1;
const imageIndex = (reservoirNumber - 1) % 4;
const vrImage = vrImageFiles[imageIndex];
```

### 2. **图像配置数组**
```javascript
const vrImageFiles = [
  { path: "/vr-images/1.hdr", fileSize: "27MB", optimized: false }, // 索引0 = 测试水库1,5,9...
  { path: "/vr-images/2.hdr", fileSize: "5.8MB", optimized: true },  // 索引1 = 测试水库2,6,10...
  { path: "/vr-images/3.hdr", fileSize: "6.3MB", optimized: true },  // 索引2 = 测试水库3,7,11...
  { path: "/vr-images/4.hdr", fileSize: "7.2MB", optimized: true }   // 索引3 = 测试水库4,8,12...
];
```

## 🎯 使用效果

### **测试场景示例**
- 🏞️ **测试水库1**: 打开VR查看 → 使用1.hdr → 显示"测试水库1 - HDR全景"
- 🏞️ **测试水库2**: 打开VR查看 → 使用2.hdr → 显示"测试水库2 - HDR全景"  
- 🏞️ **测试水库3**: 打开VR查看 → 使用3.hdr → 显示"测试水库3 - HDR全景"
- 🏞️ **测试水库4**: 打开VR查看 → 使用4.hdr → 显示"测试水库4 - HDR全景"
- 🏞️ **测试水库5**: 打开VR查看 → 使用1.hdr → 显示"测试水库5 - HDR全景" (循环开始)

### **控制台日志输出**
```
测试水库1 使用VR图像: /vr-images/1.hdr (循环位置: 1)
测试水库2 使用VR图像: /vr-images/2.hdr (循环位置: 2)
测试水库3 使用VR图像: /vr-images/3.hdr (循环位置: 3)
测试水库4 使用VR图像: /vr-images/4.hdr (循环位置: 4)
测试水库5 使用VR图像: /vr-images/1.hdr (循环位置: 1)
```

## 🚀 性能优化优势

### **1. 资源利用均衡**
- ✅ 避免所有水库都使用同一个大文件
- ✅ 1.hdr (27MB) 只有25%的水库使用
- ✅ 其他75%的水库使用较小的文件

### **2. 加载速度分布**
| VR图像 | 使用频率 | 加载时间 | 影响范围 |
|--------|----------|----------|----------|
| 1.hdr  | 25%      | ~15-30秒 | 测试水库1,5,9,13... |
| 2.hdr  | 25%      | ~3-6秒   | 测试水库2,6,10,14... |
| 3.hdr  | 25%      | ~3-7秒   | 测试水库3,7,11,15... |
| 4.hdr  | 25%      | ~4-8秒   | 测试水库4,8,12,16... |

### **3. 缓存优化效果**
- ✅ 每4个水库为一个循环周期
- ✅ 用户访问过的VR图像会被缓存
- ✅ 第2轮访问时加载时间 < 1秒

## 🔧 配置灵活性

### **支持的水库命名格式**
- ✅ `测试水库1` → 使用1.hdr
- ✅ `测试水库10` → 使用2.hdr
- ✅ `测试水库999` → 使用3.hdr
- ✅ `测试水库ABC` → 降级使用默认配置

### **非测试水库**
- 其他命名的水库仍使用原有配置
- 例如："生产水库1" → 使用默认配置

## 📊 循环验证表

| 编号 | 计算公式 | 图像索引 | VR文件 |
|------|----------|----------|--------|
| 1    | (1-1)%4=0 | 0 | 1.hdr |
| 2    | (2-1)%4=1 | 1 | 2.hdr |
| 3    | (3-1)%4=2 | 2 | 3.hdr |
| 4    | (4-1)%4=3 | 3 | 4.hdr |
| 5    | (5-1)%4=0 | 0 | 1.hdr |
| 6    | (6-1)%4=1 | 1 | 2.hdr |
| 7    | (7-1)%4=2 | 2 | 3.hdr |
| 8    | (8-1)%4=3 | 3 | 4.hdr |
| 9    | (9-1)%4=0 | 0 | 1.hdr |
| 10   | (10-1)%4=1 | 1 | 2.hdr |

## ✅ 测试步骤

### **1. 重新构建项目**
```powershell
cd "D:\水库二期\forShow\plus\vr-forlc"
pnpm run build
```

### **2. 重启Nginx**
```powershell
cd "D:\水库二期\forShow\nginx\nginx-1.24.0"
.\nginx.exe -s quit
.\nginx.exe
```

### **3. 测试验证**
1. 访问 `http://192.168.150.253:1999`
2. 点击不同的测试水库
3. 观察控制台输出的VR图像路径
4. 验证循环调用是否正确

## 🎉 优化成果

✅ **灵活的循环调用机制**: 1-2-3-4-1-2-3-4 无限循环  
✅ **性能均衡分布**: 避免所有水库使用大文件  
✅ **动态场景生成**: 根据水库编号自动分配VR资源  
✅ **向后兼容**: 非测试水库仍使用原配置  
✅ **调试友好**: 控制台输出详细的调用信息  

现在您的测试水库将按照指定的1-2-3-4循环顺序调用VR资源！ 